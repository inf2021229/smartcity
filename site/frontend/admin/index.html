<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UrbanEye — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">UrbanEye — Admin</div>
      <button class="btn danger" id="logoutBtn" title="Log out">Log out</button>
    </header>

    <main class="wrap">

      <section id="login" class="card">
        <div class="inner">
          <h2>Admin sign in</h2>
          <p class="muted">Use your admin email and password.</p>
          <div class="stack">
            <input id="email" type="email" placeholder="Email" />
            <input id="password" type="password" placeholder="Password" />
            <button id="loginBtn" class="btn primary">Sign in</button>
            <div id="loginError" class="error hide"></div>
          </div>
        </div>
      </section>

      <section id="dash" class="hide">
        <div class="card" style="margin-bottom:14px">
          <div class="inner">
            <div class="row" id="countersRow">
              <div class="pill red">New <span class="count" id="New">0</span></div>
              <div class="pill orange">In&nbsp;Progress <span class="count" id="Prog">0</span></div>
              <div class="pill green">Fixed <span class="count" id="Fix">0</span></div>
              <span class="muted" id="summary" style="margin-left:10px"></span>
            </div>
          </div>
        </div>

        <div class="controls">
          <label>Status
            <select id="statusFilter">
              <option value="">All</option>
              <option value="1">New</option>
              <option value="2">In Progress</option>
              <option value="0">Fixed</option>
            </select>
          </label>
          <input id="searchBox" placeholder="Search description…" />
          <button class="btn" id="refreshBtn">Refresh</button>
        </div>

        <div class="card">
          <div class="inner" style="padding:0">
            <table id="tbl">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Coords</th>
                  <th>Created</th>
                  <th style="width:120px">Status</th>
                  <th style="width:260px">Actions</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  const session_key = '';

  const loginBox  = document.getElementById('login');
  const dashBox   = document.getElementById('dash');
  const loginBtn  = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const u_email   = document.getElementById('email');
  const u_pass    = document.getElementById('password');
  const err     = document.getElementById('loginError');

  const New  = document.getElementById('New');
  const Prog = document.getElementById('Prog');
  const Fix  = document.getElementById('Fix');
  const summary = document.getElementById('summary');
  const tbody = document.getElementById('rows');
  const statusFilter = document.getElementById('statusFilter');
  const searchBox = document.getElementById('searchBox');
  const refreshBtn = document.getElementById('refreshBtn');

  logoutBtn.classList.add('hide');

  function getSession(){
    try { return JSON.parse(sessionStorage.getItem(session_key)); }
    catch { return null; }
  }
  function setSession(obj){ sessionStorage.setItem(session_key, JSON.stringify(obj)); }
  function clearSession(){ sessionStorage.removeItem(session_key); }

  function showLogin(){
    loginBox.classList.remove('hide');
    dashBox.classList.add('hide');
    logoutBtn.classList.add('hide');
  }
  function showDash(){
    loginBox.classList.add('hide');
    dashBox.classList.remove('hide');
    logoutBtn.classList.remove('hide');
  }

  async function AdminLogin(){
    err.classList.add('hide'); err.textContent='';
    const email = u_email.value.trim();
    const password = u_pass.value;
    if(!email || !password){
      err.textContent='Enter email and password.';
      err.classList.remove('hide');
      return;
    }
    try{
      const res = await fetch('/api/login',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({email,password})
      });
      const data = await res.json();
      if(!res.ok) throw new Error('Login failed');
      if(!data?.user?.is_admin) throw new Error('This account is not an admin.');

      const u = { email: data.user.email, id: String(data.user._id), is_admin: true };
      setSession(u);
      showDash();
      await loadReports();
    }catch(e){
      err.textContent = 'Login error';
      err.classList.remove('hide');
    }
  }

  loginBtn.onclick = AdminLogin;
  logoutBtn.onclick = ()=>{ clearSession(); showLogin(); };

  async function fetchReports(){
    const res = await fetch('/api/reports');
    const data = await res.json();
    if(!res.ok) throw new Error('Failed to load reports');
    return Array.isArray(data)? data : (data?.reports || []);
  }

  function statusBadge(s){
    if(s===1) return '<span class="badge red">New</span>';
    if(s===2) return '<span class="badge orange">In Progress</span>';
    if(s===0) return '<span class="badge green">Fixed</span>';
    return '<span class="badge">Unknown</span>';
  }

  function toDateStr(date){
    const d = new Date(date);
    const p = n => String(n).padStart(2,'0');
    const day = p(d.getDate());
    const month = p(d.getMonth() + 1);
    const year = d.getFullYear();
    const hours = p(d.getHours());
    const minutes = p(d.getMinutes());
    return `${day}/${month}/${year} ${hours}:${minutes}`;
  }

  function renderRows(list){
    tbody.innerHTML = '';
    list.forEach(r=>{
      const reportRow = document.createElement('tr');
      reportRow.dataset.id = String(r._id);
      reportRow.innerHTML = `
        <td>${r.description}</td>
        <td>${(r.latitude?.toFixed?.(5) ?? '')}, ${(r.longitude?.toFixed?.(5) ?? '')}</td>
        <td>${toDateStr(r.createdAt)}</td>
        <td>${statusBadge(r.status)}</td>
        <td>
          <div class="actions">
            <button class="btn" data-act="set" data-id="${r._id}" data-val="1">New</button>
            <button class="btn" data-act="set" data-id="${r._id}" data-val="2">In Progress</button>
            <button class="btn" data-act="set" data-id="${r._id}" data-val="0">Fixed</button>
            <button class="btn danger" data-act="del" data-id="${r._id}">Delete</button>
          </div>
        </td>`;
      tbody.appendChild(reportRow);
    });
  }

  function renderCounters(list){
    let n=0,p=0,f=0;
    list.forEach(r=>{ if(r.status===1) n++; else if(r.status===2) p++; else if(r.status===0) f++; });
    New.textContent=n; Prog.textContent=p; Fix.textContent=f;
    summary.textContent = `Showing ${list.length} reports.`;
  }

  function applyFilters(all){
    const s = statusFilter.value;
    const q = searchBox.value.trim().toLowerCase();
    let list = all;
    if(s!==''){ list = list.filter(r => String(r.status)===s); }
    if(q){ list = list.filter(r => (r.description||'').toLowerCase().includes(q)); }
    return list.sort((a,b)=> (new Date(b.createdAt)-new Date(a.createdAt)));
  }

  let cache = [];
  async function loadReports(){
    const all = await fetchReports();
    cache = all;
    const filtered = applyFilters(all);
    renderRows(filtered);
    renderCounters(filtered);
  }

  statusFilter.onchange = ()=>{ const filtered = applyFilters(cache); renderRows(filtered); renderCounters(filtered); };
  searchBox.oninput   = ()=>{ const filtered = applyFilters(cache); renderRows(filtered); renderCounters(filtered); };
  refreshBtn.onclick  = loadReports;

    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      try{
        if(act==='set'){
          const val = Number(btn.getAttribute('data-val'));
          await fetch(`/api/reports/${id}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: val })
          });
        }else if(act==='del'){
          await fetch(`/api/reports/${id}`, { method: 'DELETE' });
        }
        await loadReports();
      }catch(err){ alert('Action failed'); }
    });

  const sess = getSession();
  if(sess?.is_admin){ showDash(); loadReports(); } else { showLogin(); }
</script>
</body>
</html>